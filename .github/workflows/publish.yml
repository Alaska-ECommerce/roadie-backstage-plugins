name: Semantic Release

on:
  workflow_dispatch:

jobs:
  semantic_release:
    name: 'Semantic Release'
    runs-on: ubuntu-latest

    steps:
      # - uses: rtCamp/action-cleanup@master
      #   name: Clean Workspace
      - name: Checkout Source Code
        uses: actions/checkout@v2

      # - name: Setup Github Packages Registry
      #   uses: actions/setup-node@v2.5.1
      #   with:
      #     registry-url: 'https://itsals.pkgs.visualstudio.com/_packaging/as.com-npm/npm/registry/'
      #     always-auth: true
      #     token: ${{ secrets.ADOB64 }}
      # - run: 
      #   |
      #     echo "//registry.npmjs.org/:_authToken=${{secrets.GHB64}}" >> .npmrc
      #     echo "_auth = ${{ secrets.GHB64 }}" >> .npmrc
      #     echo "always-auth = true" >> .npmrc

      - name: Build Package
        run: |
          yarn install
          yarn tsc
          yarn build

      # - name: Semantic Release (Dry Run)
      #   if: ${{ github.ref != 'refs/heads/main'  }}
      #   run: |
      #     npm run release -- --dry-run --branches ${GITHUB_REF#refs/heads/}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      #     NPM_TOKEN: ${{ secrets.GH_TOKEN }}
      #     NODE_AUTH_TOKEN: ${{ secrets.GH_TOKEN }}
      # - name: Authenticate with private NPM package
      #   run: echo "//registry.npmjs.org/:_authToken=${{ secrets.ADOB64 }}" > ~/.npmrc

      - name: Run publish
        run: |

          # sed -i -e s/REPLACEBASE64PAT/${{ secrets.ADOB64 }}/g ./packages/app/.npmrc
          # sed -i -e s/REPLACEBASE64PAT/${{ secrets.ADOB64 }}/g ./packages/backend/.npmrc

          # cat ./packages/app/.npmrc
          # cat ./packages/backend/.npmrc
          # echo "//registry.npmjs.org/:_authToken=${{ secrets.ADO_PAT }}" >> .npmrc
          # echo "_auth = ${{ secrets.ADO_PAT }}" >> .npmrc
          # echo "always-auth = true" >> .npmrc

          # git config user.name "ecomm-github-automtn"
          # git config user.email "ecomm_github_automtn@alaskaair.com"
                  
          # git update-index --assume-unchanged ./packages/app/.npmrc
          # git update-index --assume-unchanged ./packages/backend/.npmrc
          
          # npm login --registry=https://itsals.pkgs.visualstudio.com/_packaging/as.com-npm/npm/registry/
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.ADOB64 }}